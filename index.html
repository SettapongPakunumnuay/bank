<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POP MART Auto Bot</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 380px; margin: auto; padding: 20px; background-color: #f4f4f5;
    }
    .container {
      background-color: white; padding: 25px; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    img { width: 100px; display: block; margin: 0 auto 15px; }
    h2 { font-size: 20px; text-align: center; color: #111; margin-bottom: 25px; }
    label { display: block; margin-top: 15px; font-weight: 500; color: #333; font-size: 14px; }
    select, input, textarea, button {
      width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px;
      border: 1px solid #ddd; box-sizing: border-box; font-size: 16px;
    }
    button {
      background: #e60012; color: white; font-weight: bold; cursor: pointer;
      transition: background-color 0.2s;
    }
    button:hover { background: #c0000f; }
    textarea { height: 120px; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://i.ibb.co/L5ZJ1Jc/popmart-logo.png" alt="POP MART Logo" />
    <h2>Popmart AutoBot V5.0 (Final Countdown Fix)</h2>

    <label for="branch">‡∏™‡∏≤‡∏Ç‡∏≤ (Branch)</label>
    <select id="branch">
      <option>Terminal 21</option><option>Central Ladprao</option><option>Fashion Island</option>
      <option>Centralworld</option><option>MEGABANGNA</option><option>Siam Square</option>
      <option>Central Pattaya</option><option>Seacon Square</option><option>Central Westgate</option>
      <option>Central Chiangmai</option><option>Iconsiam</option><option>Central Rama 3</option>
      <option>Central Rama 2</option><option>Central Pinklao</option><option>Central Rattanathibet</option>
      <option>Central Phuket</option>
    </select>

    <label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date)</label>
    <input type="date" id="date" />

    <label for="time">‡πÄ‡∏ß‡∏•‡∏≤ (Time)</label>
    <select id="time"></select>

    <button onclick="saveSettings()">Save Settings</button>
    <button onclick="generateBookmarklet()">Copy Bookmarklet</button>
    <textarea id="bookmarkletOutput" readonly placeholder="Bookmarklet code ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
  </div>

  <script>
    const timeSelect = document.getElementById("time");
    for (let hour = 10; hour <= 20; hour++) {
      ["30", "00"].forEach((m, i) => {
        if (hour === 10 && i === 0) return;
        timeSelect.appendChild(new Option(`${hour.toString().padStart(2, "0")}:${m}`));
      });
    }
    timeSelect.appendChild(new Option("21:00"));

    const configKey = "popmartBotConfig_v5";
    window.onload = () => {
      const config = JSON.parse(localStorage.getItem(configKey)) || {};
      document.getElementById("branch").value = config.targetBranch || "Centralworld";
      document.getElementById("date").value = config.targetDate || new Date().toISOString().split('T')[0];
      document.getElementById("time").value = config.targetTime || "12:00";
    };
    function saveSettings() {
      const config = {
        targetBranch: document.getElementById("branch").value,
        targetDate: document.getElementById("date").value,
        targetTime: document.getElementById("time").value,
      };
      localStorage.setItem(configKey, JSON.stringify(config));
      alert("‚úÖ Settings Saved!");
    }

    function generateBookmarklet() {
      const config = {
        targetBranch: document.getElementById("branch").value,
        targetDate: document.getElementById("date").value,
        targetTime: document.getElementById("time").value
      };
      const payload = `
(() => {
  if (document.getElementById('bot-status-indicator')) return;

  // --- UI Functions ---
  const createStatusIndicator = () => {
    const el = document.createElement('div'); el.id = 'bot-status-indicator';
    const style = document.createElement('style');
    style.innerHTML = \`#bot-status-indicator{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);color:white;padding:12px 20px;border-radius:10px;font-family:sans-serif;font-size:16px;z-index:99999;box-shadow:0 4px 10px rgba(0,0,0,0.5);text-align:center;}\`;
    document.head.appendChild(style); document.body.appendChild(el);
  };
  const updateStatus = (text) => { const el = document.getElementById('bot-status-indicator'); if (el) el.innerHTML = text; };
  createStatusIndicator();
  updateStatus('üöÄ Bot Starting...');

  const { targetBranch, targetDate, targetTime } = ${JSON.stringify(config)};

  // --- Core Functions ---
  const waitFor = (checkFn, cb, interval = 300, timeout = 1800000) => {
    const start = Date.now();
    const loop = setInterval(() => {
      const result = checkFn();
      if (result) { clearInterval(loop); cb(result); }
      else if (Date.now() - start > timeout) { clearInterval(loop); updateStatus("‚è± Timeout"); }
    }, interval);
  };
  const isClickable = (el) => el && !el.disabled && getComputedStyle(el).pointerEvents !== 'none' && getComputedStyle(el).visibility !== 'hidden' && getComputedStyle(el).display !== 'none';
  const forceClick = (el) => { if(el){el.focus();el.click();el.dispatchEvent(new MouseEvent('click',{bubbles:true}));} };

  // --- Step Functions ---
  const startFromConfirm = () => {
    updateStatus('‚úÖ Confirming...');
    waitFor(() => [...document.querySelectorAll("button")].find(b => b.innerText.toLowerCase().includes('confirm') && isClickable(b)), (btn) => {
      forceClick(btn);
      updateStatus('üéâ Success!');
      setTimeout(() => document.getElementById('bot-status-indicator')?.remove(), 3000);
    });
  };
  const startFromSelectTime = () => {
    updateStatus(\`üïí Selecting Time: \${targetTime}\`);
    waitFor(() => [...document.querySelectorAll(".time-btn, .timeButtons")].find(b => b.innerText.trim() === targetTime && isClickable(b)), (btn) => {
      forceClick(btn);
      startFromConfirm();
    });
  };
  const startFromSelectDay = () => {
    const day = new Date(targetDate).getDate().toString();
    updateStatus(\`üìÖ Selecting Day: \${day}\`);
    waitFor(() => [...document.querySelectorAll(".calendar-cell, .day-selectable, button[role='gridcell']")].find(b => b.innerText.trim() === day && isClickable(b)), (btn) => {
      forceClick(btn);
      startFromSelectTime();
    });
  };
  const startFromNext = () => {
    updateStatus('‚û°Ô∏è Clicking Next...');
    waitFor(() => [...document.querySelectorAll("button")].find(b => b.innerText.toLowerCase().includes('next') && isClickable(b)), (btn) => {
      forceClick(btn);
      startFromSelectDay();
    });
  };
  const startFromBranch = () => {
    updateStatus(\`üè¢ Selecting Branch: \${targetBranch}\`);
    waitFor(() => [...document.querySelectorAll(".branch-item")].find(el => el.innerText.includes(targetBranch) && !el.classList.contains("full")), (el) => {
      forceClick(el);
      startFromNext();
    });
  };
  const startFromRegister = () => {
    updateStatus('üîç Clicking Register...');
    waitFor(() => [...document.querySelectorAll("button")].find(b => b.innerText.toLowerCase().includes('register') && isClickable(b)), (btn) => {
      forceClick(btn);
      startFromBranch();
    });
  };
  
  // *** NEW ROBUST COUNTDOWN LOGIC ***
  const startBotFlow = () => {
    updateStatus("‚è≥ Waiting for Countdown...");
    waitFor(() => {
        const countdownEl = [...document.querySelectorAll("div,span,p")].find(el => el.innerText?.trim().match(/^(\\d{1,2})\\s*:\\s*\\d{1,2}/));
        if (!countdownEl) return false; // ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ
        
        const text = countdownEl.innerText.trim();
        updateStatus(\`‚è≥ Countdown: \${text}\`); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠
        
        const numbersOnly = text.replace(/[^0-9]/g, '');
        return numbersOnly.length > 0 && parseInt(numbersOnly, 10) === 0; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ true ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      }, 
      () => { // Callback function fires only when countdown is zero
        updateStatus('‚úÖ Countdown Finished!');
        startFromRegister();
      }
    );
  };

  // ‚úÖ STARTING LOGIC
  const registerButton = [...document.querySelectorAll("button")].find(b => b.innerText.toLowerCase().includes('register'));
  if (document.querySelector(".time-btn, .timeButtons")) {
    updateStatus("‚è© Found Time Selection");
    startFromSelectTime();
  } else if (document.querySelector(".calendar-cell") && !registerButton) {
    updateStatus("‚è© Found Calendar");
    startFromSelectDay();
  } else if (document.querySelector(".branch-item") && !registerButton) {
    updateStatus("‚è© Found Branch Selection");
    startFromBranch();
  } else {
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏≠ Countdown ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà
    startBotFlow();
  }
})();`;
      document.getElementById("bookmarkletOutput").value = "javascript:" + encodeURIComponent(payload);
      document.getElementById("bookmarkletOutput").select();
      document.execCommand("copy");
      alert("üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Bookmarklet ‡πÅ‡∏•‡πâ‡∏ß! (V5.0 - Final Countdown Fix)");
    }
  </script>
</body>
</html>