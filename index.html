<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POP MART Auto Bot</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 380px;
      margin: auto;
      padding: 20px;
      background-color: #f4f4f5;
    }
    .container {
      background-color: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    img {
      width: 100px;
      display: block;
      margin: 0 auto 15px;
    }
    h2 {
      font-size: 20px;
      text-align: center;
      color: #111;
      margin-bottom: 25px;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: 500;
      color: #333;
      font-size: 14px;
    }
    select, input {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background-color: #fafafa;
      box-sizing: border-box;
    }
    button {
      background: #e60012;
      color: white;
      width: 100%;
      padding: 12px;
      margin-top: 20px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      border-radius: 8px;
      font-size: 16px;
      transition: background-color 0.2s;
    }
    button:hover {
      background: #c0000f;
    }
    textarea {
      margin-top: 20px;
      width: 100%;
      height: 120px;
      font-size: 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      padding: 10px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://i.ibb.co/L5ZJ1Jc/popmart-logo.png" alt="POP MART Logo" />
    <h2>Popmart AutoBot V3 (Extension Logic)</h2>

    <label for="branch">‡∏™‡∏≤‡∏Ç‡∏≤ (Branch)</label>
    <select id="branch">
      <option>Terminal 21</option>
      <option>Central Ladprao</option>
      <option>Fashion Island</option>
      <option>Centralworld</option>
      <option>MEGABANGNA</option>
      <option>Siam Square</option>
      <option>Central Pattaya</option>
      <option>Seacon Square</option>
      <option>Central Westgate</option>
      <option>Central Chiangmai</option>
      <option>Iconsiam</option>
      <option>Central Rama 3</option>
      <option>Central Rama 2</option>
      <option>Central Pinklao</option>
      <option>Central Rattanathibet</option>
      <option>Central Phuket</option>
    </select>

    <label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date)</label>
    <input type="date" id="date" />

    <label for="time">‡πÄ‡∏ß‡∏•‡∏≤ (Time)</label>
    <select id="time"></select>

    <button onclick="saveSettings()">Save Settings</button>
    <button onclick="generateBookmarklet()">Copy Bookmarklet</button>

    <textarea id="bookmarkletOutput" readonly placeholder="Bookmarklet code ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
  </div>

  <script>
    const timeSelect = document.getElementById("time");
    for (let hour = 10; hour <= 20; hour++) {
      ["30", "00"].forEach((m, i) => {
        if (hour === 10 && i === 0) return;
        const h = hour.toString().padStart(2, "0");
        timeSelect.appendChild(new Option(`${h}:${m}`, `${h}:${m}`));
      });
    }
    timeSelect.appendChild(new Option("21:00", "21:00"));

    window.onload = () => {
      const config = JSON.parse(localStorage.getItem("popmartBotConfig")) || {};
      document.getElementById("branch").value = config.targetBranch || "Centralworld";
      document.getElementById("date").value = config.targetDate || new Date().toISOString().split('T')[0];
      document.getElementById("time").value = config.targetTime || "12:00";
    };

    function saveSettings() {
      const config = {
        targetBranch: document.getElementById("branch").value,
        targetDate: document.getElementById("date").value,
        targetTime: document.getElementById("time").value,
      };
      localStorage.setItem("popmartBotConfig", JSON.stringify(config));
      alert("‚úÖ Settings Saved!");
    }

    function generateBookmarklet() {
      const config = {
        targetBranch: document.getElementById("branch").value,
        targetDate: document.getElementById("date").value,
        targetTime: document.getElementById("time").value
      };

      const payload = `
(() => {
  if (document.getElementById('bot-status-indicator')) return;

  const createStatusIndicator = () => {
    const el = document.createElement('div');
    el.id = 'bot-status-indicator';
    const style = document.createElement('style');
    style.innerHTML = \`
      #bot-status-indicator {
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.8); color: white; padding: 12px 20px;
        border-radius: 10px; font-family: sans-serif; font-size: 16px;
        z-index: 99999; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      }
    \`;
    document.head.appendChild(style);
    document.body.appendChild(el);
  };
  const updateStatus = (text) => {
    const el = document.getElementById('bot-status-indicator');
    if (el) el.innerHTML = text;
  };
  createStatusIndicator();
  updateStatus('üöÄ ‡∏ö‡∏≠‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô');

  const { targetBranch, targetDate, targetTime } = ${JSON.stringify(config)};

  const waitFor = (checkFn, callback, interval = 300, timeout = 1800000) => {
    const start = Date.now();
    const loop = setInterval(() => {
      const result = checkFn();
      if (result) {
        clearInterval(loop); callback(result);
      } else if (Date.now() - start > timeout) {
        clearInterval(loop); updateStatus("‚è± Timeout: ‡∏´‡∏≤ Element ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠");
      }
    }, interval);
  };

  const isClickable = (el) => el && !el.disabled && getComputedStyle(el).pointerEvents !== "none" && getComputedStyle(el).visibility !== "hidden" && getComputedStyle(el).display !== "none";
  
  const forceClick = (el) => {
    if (!el) return;
    try { el.focus(); el.click(); el.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true })); } catch (e) { updateStatus("‚ùå Click ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
  };
  
  const findButtonFlexible = (label) => {
    const target = label.toLowerCase();
    return [...document.querySelectorAll("button, div, span")].find((el) => {
      const text = el.innerText?.replace(/\\n/g, "").trim().toLowerCase() || "";
      const isVisible = el.offsetWidth > 0 && el.offsetHeight > 0;
      const looksLikeTarget = text.includes(target);
      if (isClickable(el) && isVisible && looksLikeTarget) return el;
      return null;
    });
  };
  
  const waitForCountdownToFinish = (callback) => {
    updateStatus("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠ Countdown...");
    const loop = setInterval(() => {
      const countdownEl = [...document.querySelectorAll("div, span, p")].find(el => el.innerText?.trim().match(/^(\\d{1,2})(\\s*[:]\\s*\\d{1,2}){2,3}$/));
      if (!countdownEl) {
        clearInterval(loop); callback(); return;
      }
      const text = countdownEl.innerText.trim();
      const numbersOnly = text.replace(/[^0-9]/g, '');
      const isZero = numbersOnly.length > 0 && parseInt(numbersOnly, 10) === 0;

      if (isZero) {
        clearInterval(loop); updateStatus("‚úÖ Countdown ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"); callback();
      } else {
        updateStatus(\`‚è≥ ‡∏£‡∏≠ Countdown: \${text}\`);
      }
    }, 300);
  };

  const startFromConfirm = () => {
    updateStatus("‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...");
    waitFor(() => findButtonFlexible("confirm"), (confirmBtn) => {
      forceClick(confirmBtn);
      updateStatus("üéâ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
      setTimeout(() => document.getElementById('bot-status-indicator')?.remove(), 3000);
    });
  };
  
  const startFromSelectTime = () => {
    updateStatus(\`üïí ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤: \${targetTime}\`);
    waitFor(() => [...document.querySelectorAll("button.timeButtons, button.time-btn")].find(btn => btn.innerText.trim() === targetTime && isClickable(btn)),
    (timeBtn) => { setTimeout(() => { forceClick(timeBtn); startFromConfirm(); }, 300); });
  };
  
  const startFromSelectDay = () => {
    const day = new Date(targetDate).getDate().toString();
    updateStatus(\`üìÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: \${day}\`);
    waitFor(() => [...document.querySelectorAll("button[role='gridcell'], .calendar-cell, .day-selectable")].find(el => el.innerText.trim() === day && isClickable(el)),
    (dayEl) => { forceClick(dayEl); startFromSelectTime(); });
  };
  
  const startFromNext = () => {
    updateStatus("‚û°Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏î Next...");
    waitFor(() => findButtonFlexible("next"), (nextBtn) => { forceClick(nextBtn); startFromSelectDay(); });
  };
  
  const startFromBranch = () => {
    updateStatus(\`üè¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤: \${targetBranch}\`);
    waitFor(() => [...document.querySelectorAll(".branch-item")].find(el => el.innerText.trim().includes(targetBranch.trim()) && !el.classList.contains("full")),
    (branchEl) => { forceClick(branchEl); startFromNext(); });
  };
  
  const startFromRegister = () => {
    updateStatus("üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏° Register...");
    waitFor(() => findButtonFlexible("register"), (registerBtn) => { forceClick(registerBtn); startFromBranch(); });
  };

  // ‚úÖ STARTING LOGIC FROM EXTENSION
  if (document.querySelector("button.timeButtons, button.time-btn")) {
    updateStatus("‚è© ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
    startFromSelectTime();
  } else if (document.querySelector("button[role='gridcell'], .calendar-cell")) {
    updateStatus("‚è© ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
    startFromSelectDay();
  } else if (document.querySelector(".branch-item") && (!findButtonFlexible("register") || document.querySelector("button.Next, .Next"))) {
    updateStatus("‚è© ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
    startFromBranch();
  } else {
    waitForCountdownToFinish(() => {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á Countdown ‡πÄ‡∏™‡∏£‡πá‡∏à
      if (document.querySelector(".branch-item") && (!findButtonFlexible("register") || document.querySelector("button.Next, .Next"))) {
        updateStatus("‚è© Post-countdown: ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
        startFromBranch();
      } else {
        startFromRegister();
      }
    });
  }
})();`;

      const bookmarklet = "javascript:" + encodeURIComponent(payload);
      const output = document.getElementById("bookmarkletOutput");
      output.value = bookmarklet;
      output.select();
      document.execCommand("copy");
      alert("üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Bookmarklet ‡πÅ‡∏•‡πâ‡∏ß! (‡∏à‡∏≤‡∏Å Logic ‡∏Ç‡∏≠‡∏á Extension)");
    }
  </script>
</body>
</html>